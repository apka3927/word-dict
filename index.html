<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¨ì–´ ì‚¬ì „ Â· ì•ˆì „ë²„ì „</title>
  <!-- Tailwind (CDN) -->
  <script>tailwind = { config: { darkMode: 'class' } };</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html { background: #0b1220; }
    body { background: #0b1220; color: #e5e7eb; }
    .card { background: rgba(17,24,39,.7); border: 1px solid rgba(148,163,184,.2); border-radius: 16px; }
    .input { background:#0f172a; border:1px solid #334155; color:#e5e7eb; border-radius:10px; padding:.55rem .75rem; font-size:.9rem; width:100%; }
    .btn { background:#10b981; color:white; border-radius:10px; padding:.55rem .9rem; font-weight:600; }
    .btn-outline { border:1px solid #475569; border-radius:10px; padding:.45rem .8rem; }
    .tag { border:1px solid #334155; border-radius:9999px; padding:.15rem .6rem; font-size:.75rem; }
    .muted { color:#94a3b8; }
    a { color:#93c5fd }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:.75rem; }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-xl font-semibold">ë‹¨ì–´ ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì •/ì‚­ì œ (ì•ˆì „ë²„ì „)</h1>
      <div class="flex items-center gap-2">
        <span id="adminBadge" class="tag">ğŸ”’ ì ê¸ˆ ì¤‘</span>
      </div>
    </header>

    <!-- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì˜ì—­ -->
    <div class="card p-4 mb-6">
      <div class="flex items-center gap-2 flex-wrap">
        <input id="pwd" type="password" class="input w-64" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" />
        <button id="btnCheck" class="btn">í™•ì¸</button>
        <span class="muted text-sm">* í†µê³¼í•´ì•¼ ìˆ˜ì •/ì‚­ì œê°€ ë©ë‹ˆë‹¤.</span>
      </div>
      <div id="sysmsg" class="text-xs mt-2 text-rose-400"></div>
    </div>

    <!-- ë“±ë¡ í¼ -->
    <div class="card p-4 mb-6">
      <h2 class="font-semibold mb-3">ë‹¨ì–´ ë“±ë¡</h2>
      <div class="grid2 mb-2">
        <div>
          <div class="text-xs muted mb-1">ë‹¨ì–´</div>
          <input id="newWord" class="input" placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤" />
        </div>
        <div>
          <div class="text-xs muted mb-1">ë¶„ë¥˜</div>
          <select id="newCat" class="input">
            <option>ìˆëŠ”ë§</option>
            <option>ìˆë˜ë§</option>
            <option>ë§Œë“ ë§</option>
          </select>
        </div>
      </div>
      <div class="mb-2">
        <div class="text-xs muted mb-1">ëœ»</div>
        <textarea id="newMeaning" class="input" rows="3" placeholder="ì˜ˆ: íš¡í¬(æ©«æš´)í•˜ë‹¤"></textarea>
      </div>
      <div class="mb-3">
        <div class="text-xs muted mb-1">ë§Œë“ ë°©ë²•</div>
        <input id="newMethod" class="input" placeholder="ì˜ˆ: pisk-(æ©«) + mwÇ’til-(æš´) ì§ì—­" />
      </div>
      <div class="flex gap-2">
        <button id="btnAdd" class="btn">ì¶”ê°€</button>
        <button id="btnClear" class="btn-outline">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- ê²€ìƒ‰ -->
    <div class="card p-4 mb-4">
      <h2 class="font-semibold mb-3">ê²€ìƒ‰</h2>
      <div class="grid3">
        <input id="q" class="input" placeholder="ë‹¨ì–´/ëœ»/ë§Œë“ ë°©ë²• ê²€ìƒ‰" />
        <select id="filterCat" class="input">
          <option>ì „ì²´</option>
          <option>ìˆëŠ”ë§</option>
          <option>ìˆë˜ë§</option>
          <option>ë§Œë“ ë§</option>
        </select>
        <button id="btnReload" class="btn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="count" class="text-xs muted mt-2"></div>
    </div>

    <!-- ëª©ë¡ -->
    <ul id="list" class="grid2"></ul>
  </div>

  <script defer>
  (function(){
    const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = {
      adminOK: false,
      adminPwd: '',
      q: '',
      cat: 'ì „ì²´',
      entries: [],
      loading: false,
    };

    const el = (id) => document.getElementById(id);
    const $list = el('list');
    const $count = el('count');
    const $sys = el('sysmsg');

    function setBadge(){
      const b = el('adminBadge');
      b.textContent = state.adminOK ? 'ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ' : 'ğŸ”’ ì ê¸ˆ ì¤‘';
    }

    async function verifyPwd(){
      state.adminPwd = el('pwd').value;
      if(!state.adminPwd){ alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥'); return; }
      $sys.textContent = '';
      try{
        const { data, error } = await db.rpc('can_edit', { pwd: state.adminPwd });
        if(error) throw error;
        if(!data){ state.adminOK = false; setBadge(); alert('í‹€ë¦° ë¹„ë°€ë²ˆí˜¸'); return; }
        state.adminOK = true; setBadge(); alert('ê´€ë¦¬ì ëª¨ë“œ ON');
      }catch(e){
        $sys.textContent = 'ê²€ì¦ ì˜¤ë¥˜: ' + (e.message || e);
      }
    }

    async function load(){
      state.q = el('q').value.trim();
      state.cat = el('filterCat').value;
      $sys.textContent = '';
      state.loading = true; renderList();
      try{
        let query = db.from('entries').select('*').order('created_at', { ascending: false });
        if(state.cat !== 'ì „ì²´') query = query.eq('category', state.cat);
        if(state.q) query = query.or(`word.ilike.%${state.q}%,meaning.ilike.%${state.q}%,method.ilike.%${state.q}%`);
        const { data, error } = await query;
        if(error) throw error;
        state.entries = data || [];
      }catch(e){ $sys.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ' + (e.message || e); }
      finally{ state.loading = false; renderList(); }
    }

    function renderList(){
      $count.textContent = state.loading ? 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦' : `ì´ ${state.entries.length}ê°œ ê²°ê³¼`;
      $list.innerHTML = '';
      for(const e of state.entries){
        const li = document.createElement('li');
        li.className = 'card p-4';
        li.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <div class="text-lg font-semibold">${escapeHtml(e.word)}</div>
              <div class="text-xs muted">${new Date(e.created_at).toLocaleString()}</div>
            </div>
            <span class="tag">${escapeHtml(e.category)}</span>
          </div>
          <div class="mt-3">${escapeHtml(e.meaning)}</div>
          ${e.method ? `<div class="mt-2 text-sm muted">ë§Œë“ ë°©ë²•: ${escapeHtml(e.method)}</div>` : ''}
          <div class="mt-3 flex gap-2">
            <button class="btn-outline" data-edit="${e.id}">ìˆ˜ì •</button>
            <button class="btn-outline" data-del="${e.id}">ì‚­ì œ</button>
          </div>
          <div class="mt-3 hidden" id="edit-${e.id}">
            <div class="grid2 mb-2">
              <input class="input" id="ew-${e.id}" value="${escapeAttr(e.word)}" />
              <select class="input" id="ec-${e.id}">
                ${['ìˆëŠ”ë§','ìˆë˜ë§','ë§Œë“ ë§'].map(c=>`<option ${c===e.category?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div class="mb-2"><textarea class="input" rows="3" id="em-${e.id}">${escapeHtml(e.meaning)}</textarea></div>
            <div class="mb-2"><input class="input" id="ed-${e.id}" value="${escapeAttr(e.method||'')}" placeholder="ë§Œë“ ë°©ë²•" /></div>
            <div class="flex gap-2">
              <button class="btn" data-save="${e.id}">ì €ì¥</button>
              <button class="btn-outline" data-cancel="${e.id}">ì·¨ì†Œ</button>
            </div>
          </div>
        `;
        $list.appendChild(li);
      }
    }

    function listClick(e){
      const t = e.target;
      const id = t.getAttribute('data-del') || t.getAttribute('data-edit') || t.getAttribute('data-save') || t.getAttribute('data-cancel');
      if(!id) return;
      if(t.hasAttribute('data-edit')) return openEdit(id);
      if(t.hasAttribute('data-cancel')) return closeEdit(id);
      if(t.hasAttribute('data-save')) return saveEdit(id);
      if(t.hasAttribute('data-del')) return removeEntry(id);
    }

    function openEdit(id){ if(!state.adminOK){ alert('ë¨¼ì € ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ í†µê³¼í•˜ì„¸ìš”.'); return; } document.getElementById(`edit-${id}`).classList.remove('hidden'); }
    function closeEdit(id){ document.getElementById(`edit-${id}`).classList.add('hidden'); }

    async function saveEdit(id){
      if(!state.adminOK){ alert('ë¨¼ì € ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ í†µê³¼í•˜ì„¸ìš”.'); return; }
      const word = document.getElementById(`ew-${id}`).value.trim();
      const category = document.getElementById(`ec-${id}`).value;
      const meaning = document.getElementById(`em-${id}`).value.trim();
      const method = document.getElementById(`ed-${id}`).value.trim();
      if(!word || !meaning){ alert('ë‹¨ì–´/ëœ» í•„ìˆ˜'); return; }
      try{
        const args = { p_id: id, p_word: word, p_meaning: meaning, p_category: category, p_method: method, p_pwd: state.adminPwd };
        const { data, error } = await db.rpc('entry_update_admin', args);
        if(error) throw error;
        await load(); alert('ìˆ˜ì • ì™„ë£Œ');
      }catch(e){ $sys.textContent = 'ìˆ˜ì • ì˜¤ë¥˜: ' + (e.message || e); alert($sys.textContent); }
    }

    async function removeEntry(id){
      if(!state.adminOK){ alert('ë¨¼ì € ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ í†µê³¼í•˜ì„¸ìš”.'); return; }
      if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
      try{
        const { data, error } = await db.rpc('entry_delete_admin', { p_id: id, p_pwd: state.adminPwd });
        if(error) throw error;
        await load(); alert('ì‚­ì œ ì™„ë£Œ');
      }catch(e){ $sys.textContent = 'ì‚­ì œ ì˜¤ë¥˜: ' + (e.message || e); alert($sys.textContent); }
    }

    async function addEntry(){
      const word = document.getElementById('newWord').value.trim();
      const meaning = document.getElementById('newMeaning').value.trim();
      const category = document.getElementById('newCat').value;
      const method = document.getElementById('newMethod').value.trim();
      if(!word || !meaning){ alert('ë‹¨ì–´/ëœ» í•„ìˆ˜'); return; }
      try{
        const { error } = await db.from('entries').insert([{ word, meaning, category, method }]);
        if(error) throw error;
        document.getElementById('newWord').value = '';
        document.getElementById('newMeaning').value = '';
        document.getElementById('newMethod').value = '';
        await load(); alert('ì¶”ê°€ ì™„ë£Œ');
      }catch(e){ $sys.textContent = 'ì¶”ê°€ ì˜¤ë¥˜: ' + (e.message || e); alert($sys.textContent); }
    }

    function escapeHtml(s=''){ return s.replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function escapeAttr(s=''){ return escapeHtml(s).replace(/\n/g,' '); }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.addEventListener('click', (ev)=>{
      if(ev.target.id==='btnCheck') verifyPwd();
      if(ev.target.id==='btnAdd') addEntry();
      if(ev.target.id==='btnClear'){ el('newWord').value=''; el('newMeaning').value=''; el('newMethod').value=''; }
      if(ev.target.id==='btnReload') load();
    });
    $list.addEventListener('click', listClick);
    el('q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(load, 250); });
    el('filterCat').addEventListener('change', load);

    setBadge();
    load();
  })();
  </script>
</body>
</html>
