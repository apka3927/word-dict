<!doctype html>
<html lang="ko" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë‹¨ì–´ ì‚¬ì „ â€” ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì • (Supabase)</title>

    <!-- Tailwind (dark mode: class) -->
    <script>tailwind = { config: { darkMode: 'class' } };</script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18, ReactDOM 18, Babel (JSX ë³€í™˜) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS v2 UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="h-full">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;
      const CATEGORIES = ["ìˆëŠ”ë§", "ìˆë˜ë§", "ë§Œë“ ë§"];

      // âœ… ì‚¬ìš©ì ì œê³µ ê°’ìœ¼ë¡œ ì±„ì›€ (ë”°ì˜´í‘œ ìœ ì§€)
      const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";

      const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function WordRegistry() {
        // theme
        const [dark, setDark] = useState(() => {
          const saved = localStorage.getItem('dict.dark');
          if (saved === null) return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          return saved === '1';
        });
        useEffect(() => {
          document.documentElement.classList.toggle('dark', dark);
          localStorage.setItem('dict.dark', dark ? '1' : '0');
        }, [dark]);

        // state
        const [entries, setEntries] = useState([]);
        const [loading, setLoading] = useState(true);
        const [busy, setBusy] = useState(false); // ì „ì—­ ì‘ì—… ì¤‘
        const [err, setErr] = useState("");

        const [form, setForm] = useState({ word: '', meaning: '', category: CATEGORIES[0], method: '' });
        const [q, setQ] = useState('');
        const [cat, setCat] = useState('ì „ì²´');

        // editing state
        const [editingId, setEditingId] = useState(null);
        const [edit, setEdit] = useState({ word: '', meaning: '', category: CATEGORIES[0], method: '' });

        // load list
        async function load() {
          setLoading(true); setErr("");
          try {
            const term = q.trim();
            let query = db.from('entries').select('*').order('created_at', { ascending: false });
            if (cat !== 'ì „ì²´') query = query.eq('category', cat);
            if (term) query = query.or(`word.ilike.%${term}%,meaning.ilike.%${term}%,method.ilike.%${term}%`);
            const { data, error } = await query;
            if (error) throw error;
            setEntries(data || []);
          } catch (e) {
            console.error(e); setErr(e.message || String(e));
          } finally { setLoading(false); }
        }
        useEffect(() => { load(); }, []);
        useEffect(() => { const id = setTimeout(load, 250); return () => clearTimeout(id); }, [q, cat]);

        // create
        async function addEntry() {
          const word = form.word.trim();
          const meaning = form.meaning.trim();
          const method = form.method.trim();
          const category = form.category;
          if (!word || !meaning) return alert('ë‹¨ì–´ì™€ ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          if (!CATEGORIES.includes(category)) return alert('ë¶„ë¥˜ ì„ íƒì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          setBusy(true); setErr("");
          try {
            const { error } = await db.from('entries').insert([{ word, meaning, category, method }]);
            if (error) throw error;
            setForm({ word: '', meaning: '', category, method: '' });
            await load();
          } catch (e) { console.error(e); alert('ì €ì¥ ì˜¤ë¥˜: ' + (e.message || e)); }
          finally { setBusy(false); }
        }

        // delete
        async function removeEntry(id) {
          if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
          setBusy(true); setErr("");
          try {
            const { error } = await db.from('entries').delete().eq('id', id);
            if (error) throw error;
            await load();
          } catch (e) { console.error(e); alert('ì‚­ì œ ì˜¤ë¥˜: ' + (e.message || e)); }
          finally { setBusy(false); }
        }

        // edit begin/cancel
        function beginEdit(e) {
          setEditingId(e.id);
          setEdit({ word: e.word, meaning: e.meaning, category: e.category, method: e.method || '' });
        }
        function cancelEdit() { setEditingId(null); }

        // update
        async function saveEdit() {
          const word = edit.word.trim();
          const meaning = edit.meaning.trim();
          const method = edit.method.trim();
          const category = edit.category;
          if (!word || !meaning) return alert('ë‹¨ì–´ì™€ ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          if (!CATEGORIES.includes(category)) return alert('ë¶„ë¥˜ ì„ íƒì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          setBusy(true); setErr("");
          try {
            const { error } = await db.from('entries')
              .update({ word, meaning, category, method })
              .eq('id', editingId);
            if (error) throw error;
            setEditingId(null);
            await load();
          } catch (e) {
            console.error(e);
            alert('ìˆ˜ì • ì˜¤ë¥˜: ' + (e.message || e) + '\nâš ï¸ UPDATE ì •ì±…ì´ ì—†ìœ¼ë©´ ì•„ë˜ SQLì„ ì‹¤í–‰í•˜ì„¸ìš”:\ncreate policy "public update" on public.entries for update using (true) with check (true);');
          } finally { setBusy(false); }
        }

        function onSubmit(e) { e.preventDefault(); addEntry(); }

        return (
          <div className="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900 dark:from-slate-950 dark:to-slate-900 dark:text-slate-100">
            {/* header */}
            <header className="sticky top-0 z-10 backdrop-blur bg-white/60 dark:bg-slate-900/60 border-b border-slate-200/60 dark:border-slate-800/60">
              <div className="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="h-9 w-9 rounded-2xl bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 grid place-items-center font-bold">ğŸ“š</div>
                  <div>
                    <h1 className="text-lg font-semibold">ë‹¨ì–´ ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì •</h1>
                    <p className="text-xs text-slate-600 dark:text-slate-400">Supabase(Postgres) ì›ê²© ì €ì¥</p>
                  </div>
                </div>
                <button onClick={() => setDark(d => !d)} className="px-3 py-1.5 rounded-xl border border-slate-300 dark:border-slate-700 text-sm hover:bg-slate-100 dark:hover:bg-slate-800" aria-label="ë‹¤í¬ëª¨ë“œ">
                  {dark ? 'ğŸŒ™ ë‹¤í¬' : 'â˜€ï¸ ë¼ì´íŠ¸'}
                </button>
              </div>
            </header>

            <main className="mx-auto max-w-5xl px-4 py-8 grid lg:grid-cols-3 gap-6">
              {/* form */}
              <section className="lg:col-span-1 rounded-3xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 p-5">
                <h2 className="font-semibold">ë‹¨ì–´ ë“±ë¡</h2>
                <p className="text-xs text-slate-600 dark:text-slate-400 mt-1">ì…ë ¥ í›„ "ì¶”ê°€"ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>

                <form onSubmit={onSubmit} className="mt-4 grid gap-3">
                  <Field label="ë‹¨ì–´">
                    <input value={form.word} onChange={(e)=>setForm({ ...form, word: e.target.value })} placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤" className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" required />
                  </Field>
                  <Field label="ëœ»">
                    <textarea rows={3} value={form.meaning} onChange={(e)=>setForm({ ...form, meaning: e.target.value })} placeholder="ì˜ˆ: íš¡í¬(æ©«æš´)í•˜ë‹¤" className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" required />
                  </Field>
                  <Field label="ë¶„ë¥˜">
                    <select value={form.category} onChange={(e)=>setForm({ ...form, category: e.target.value })} className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400">
                      {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </Field>
                  <Field label="ë§Œë“ ë°©ë²•">
                    <input value={form.method} onChange={(e)=>setForm({ ...form, method: e.target.value })} placeholder="ì˜ˆ: pisk-(æ©«) + mwÇ’til-(æš´) ì§ì—­" className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" />
                  </Field>
                  <div className="flex items-center gap-2 pt-1">
                    <button type="submit" disabled={busy} className="px-4 py-2 rounded-xl bg-emerald-500 text-white font-semibold hover:opacity-90 disabled:opacity-40">ì¶”ê°€</button>
                    <button type="button" onClick={()=>setForm({ word:'', meaning:'', category: form.category, method:'' })} className="px-3 py-2 rounded-xl border border-emerald-500 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-50/60 dark:hover:bg-emerald-900/20">ì´ˆê¸°í™”</button>
                  </div>
                </form>
              </section>

              {/* search & list */}
              <section className="lg:col-span-2 space-y-4">
                <div className="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 p-5">
                  <h2 className="font-semibold">ê²€ìƒ‰</h2>
                  <div className="mt-3 grid md:grid-cols-3 gap-3">
                    <input value={q} onChange={(e)=>setQ(e.target.value)} placeholder="ë‹¨ì–´/ëœ»/ë§Œë“ ë°©ë²• ê²€ìƒ‰..." className="md:col-span-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" />
                    <select value={cat} onChange={(e)=>setCat(e.target.value)} className="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400">
                      <option value="ì „ì²´">ì „ì²´</option>
                      {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>
                  <div className="mt-2 text-xs text-slate-600 dark:text-slate-400">{loading ? 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦' : `ì´ ${entries.length}ê°œ ê²°ê³¼`}{err ? ` â€” ì˜¤ë¥˜: ${err}` : ''}</div>
                </div>

                <ul className="grid md:grid-cols-2 gap-3">
                  {entries.map(e => (
                    <li key={e.id} className="rounded-3xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 p-5">
                      {editingId === e.id ? (
                        // í¸ì§‘ ëª¨ë“œ
                        <div className="space-y-3">
                          <div className="flex items-start justify-between gap-3">
                            <h3 className="text-lg font-semibold">ìˆ˜ì •: {e.word}</h3>
                            <span className="inline-flex items-center rounded-full border border-amber-400 text-amber-700 dark:text-amber-300 px-2.5 py-1 text-xs bg-amber-50/80 dark:bg-amber-900/20">í¸ì§‘ ì¤‘</span>
                          </div>
                          <div className="grid gap-3">
                            <Field label="ë‹¨ì–´">
                              <input value={edit.word} onChange={(ev)=>setEdit({ ...edit, word: ev.target.value })} className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" />
                            </Field>
                            <Field label="ëœ»">
                              <textarea rows={3} value={edit.meaning} onChange={(ev)=>setEdit({ ...edit, meaning: ev.target.value })} className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" />
                            </Field>
                            <Field label="ë¶„ë¥˜">
                              <select value={edit.category} onChange={(ev)=>setEdit({ ...edit, category: ev.target.value })} className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400">
                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                              </select>
                            </Field>
                            <Field label="ë§Œë“ ë°©ë²•">
                              <input value={edit.method} onChange={(ev)=>setEdit({ ...edit, method: ev.target.value })} className="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400" />
                            </Field>
                          </div>
                          <div className="flex items-center gap-2 pt-1">
                            <button onClick={saveEdit} disabled={busy} className="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold disabled:opacity-40">ì €ì¥</button>
                            <button onClick={cancelEdit} disabled={busy} className="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700">ì·¨ì†Œ</button>
                          </div>
                        </div>
                      ) : (
                        // ë³´ê¸° ëª¨ë“œ
                        <div>
                          <div className="flex items-start justify-between gap-3">
                            <div>
                              <h3 className="text-lg font-semibold leading-tight">{e.word}</h3>
                              <div className="mt-1 text-xs text-slate-500 dark:text-slate-400">{new Date(e.created_at).toLocaleString()}</div>
                            </div>
                            <span className="inline-flex items-center rounded-full border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-xs bg-white/70 dark:bg-slate-900/70">{e.category}</span>
                          </div>
                          <p className="mt-3 text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap">{e.meaning}</p>
                          {e.method && (<div className="mt-2 text-xs text-slate-600 dark:text-slate-400"><span className="font-medium">ë§Œë“ ë°©ë²•:</span> {e.method}</div>)}
                          <div className="mt-4 flex items-center gap-3">
                            <button onClick={()=>beginEdit(e)} className="text-xs px-3 py-1.5 rounded-lg border border-sky-500 text-sky-600 dark:text-sky-400 hover:bg-sky-50/60 dark:hover:bg-sky-900/20">ìˆ˜ì •</button>
                            <button onClick={()=>removeEntry(e.id)} className="text-xs px-3 py-1.5 rounded-lg border border-rose-400 text-rose-600 dark:text-rose-400 hover:bg-rose-50/60 dark:hover:bg-rose-900/20">ì‚­ì œ</button>
                          </div>
                        </div>
                      )}
                    </li>
                  ))}
                </ul>

                {!loading && entries.length === 0 && (
                  <div className="rounded-3xl border border-dashed border-slate-300 dark:border-slate-700 p-8 text-center text-sm text-slate-500 dark:text-slate-400">
                    ì•„ì§ í•­ëª©ì´ ì—†ê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ í¼ì—ì„œ ìƒˆë¡œ ì¶”ê°€í•´ ë³´ì„¸ìš”.
                  </div>
                )}
              </section>
            </main>

            <footer className="mx-auto max-w-5xl px-4 py-10">
              <div className="rounded-3xl border border-slate-200 dark:border-slate-800 p-6 bg-white/70 dark:bg-slate-900/70 text-sm flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
                <p>Â© {new Date().getFullYear()} ë‹¨ì–´ ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì • (Supabase)</p>
                <div className="flex gap-4 text-slate-600 dark:text-slate-300">
                  <a className="hover:underline" href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                  <a className="hover:underline" href="#">ì´ìš©ì•½ê´€</a>
                </div>
              </div>
            </footer>
          </div>
        );
      }

      function Field({ label, children }) {
        return (
          <label className="grid gap-1">
            <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{label}</span>
            {children}
          </label>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<WordRegistry />);
    </script>
  </body>
</html>
