<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¨ì–´ ì‚¬ì „ Â· ì´ˆë¯¸ë‹ˆ ì•ˆì „ë²„ì „</title>
  <style>
    /* ìµœëŒ€í•œ ë‹¨ìˆœí•˜ê²Œ: ê²€ì€ ê¸€ì / í° ë°°ê²½ (ìŠ¤íƒ€ì¼ ìµœì†Œí™”) */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:20px;background:#fff;color:#111}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:12px 0}
    .btn{padding:6px 10px;border:1px solid #333;background:#111;color:#fff;border-radius:8px;cursor:pointer}
    .btn.sec{background:#fff;color:#111}
    .muted{color:#666;font-size:12px}
    .tag{border:1px solid #aaa;border-radius:999px;padding:2px 8px;font-size:12px}
    input,select,textarea{border:1px solid #bbb;border-radius:8px;padding:6px 8px}
    textarea{width:100%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .list{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    code,pre{background:#f6f8fa;border:1px solid #e5e7eb;border-radius:8px;padding:6px}
  </style>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>ë‹¨ì–´ ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì •/ì‚­ì œ â€” ì´ˆë¯¸ë‹ˆ ì•ˆì „ë²„ì „</h1>
  <noscript>ì´ í˜ì´ì§€ëŠ” JavaScriptê°€ í•„ìš”í•©ë‹ˆë‹¤.</noscript>

  <div class="card">
    <div class="row">
      <b>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</b>
      <input id="pwd" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button class="btn" id="btnVerify">í™•ì¸</button>
      <span id="badge" class="tag">ğŸ”’ ì ê¸ˆ ì¤‘</span>
    </div>
    <div id="sys" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h3>ë‹¨ì–´ ë“±ë¡</h3>
    <div class="grid2">
      <div>
        <div class="muted">ë‹¨ì–´</div>
        <input id="newWord" placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤" />
      </div>
      <div>
        <div class="muted">ë¶„ë¥˜</div>
        <select id="newCat">
          <option>ìˆëŠ”ë§</option>
          <option>ìˆë˜ë§</option>
          <option>ë§Œë“ ë§</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px">
      <div class="muted">ëœ»</div>
      <textarea id="newMeaning" rows="3" placeholder="ì˜ˆ: íš¡í¬(æ©«æš´)í•˜ë‹¤"></textarea>
    </div>
    <div style="margin-top:8px">
      <div class="muted">ë§Œë“ ë°©ë²•</div>
      <input id="newMethod" placeholder="ì˜ˆ: pisk-(æ©«) + mwÇ’til-(æš´) ì§ì—­" />
    </div>
    <div style="margin-top:8px" class="row">
      <button class="btn" id="btnAdd">ì¶”ê°€</button>
      <button class="btn sec" id="btnClear">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="card">
    <h3>ê²€ìƒ‰</h3>
    <div class="row">
      <input id="q" placeholder="ë‹¨ì–´/ëœ»/ë§Œë“ ë°©ë²• ê²€ìƒ‰" style="min-width:240px" />
      <select id="filterCat">
        <option>ì „ì²´</option>
        <option>ìˆëŠ”ë§</option>
        <option>ìˆë˜ë§</option>
        <option>ë§Œë“ ë§</option>
      </select>
      <button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
      <span id="count" class="muted"></span>
    </div>
  </div>

  <div id="list" class="list"></div>

  <div class="card">
    <h3>ë””ë²„ê·¸ ë¡œê·¸</h3>
    <pre id="log" style="max-height:220px;overflow:auto"></pre>
  </div>

  <script>
  (function(){
    // â›³ í”„ë¡œì íŠ¸ ì—°ê²° â€” ì‚¬ìš©ìë‹˜ì˜ ê°’
    const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { adminOK:false, adminPwd:'', q:'', cat:'ì „ì²´', entries:[], loading:false };

    // --- helpers ---
    const $ = (id) => document.getElementById(id);
    const log = (m) => { const p = $('log'); p.textContent += m + "\n"; p.scrollTop = p.scrollHeight; }
    window.onerror = function(message, src, line, col, err){ log('JS ERROR: '+message+' @'+src+':'+line); };
    const esc = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));

    function setBadge(){ $('badge').textContent = state.adminOK ? 'ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ' : 'ğŸ”’ ì ê¸ˆ ì¤‘'; }

    async function verifyPwd(){
      state.adminPwd = $('pwd').value;
      if(!state.adminPwd){ alert('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥'); return; }
      $('sys').textContent='';
      const { data, error } = await db.rpc('can_edit', { pwd: state.adminPwd });
      log('RPC can_edit â†’ data:'+data+' error:'+(error?error.message:'none'));
      if(error){ $('sys').textContent = 'ê²€ì¦ ì˜¤ë¥˜: '+error.message; state.adminOK=false; setBadge(); return; }
      if(!data){ alert('í‹€ë¦° ë¹„ë°€ë²ˆí˜¸'); state.adminOK=false; setBadge(); return; }
      state.adminOK=true; setBadge(); alert('ê´€ë¦¬ì ëª¨ë“œ ON');
    }

    async function load(){
      state.q = $('q').value.trim();
      state.cat = $('filterCat').value;
      $('sys').textContent=''; $('count').textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      let query = db.from('entries').select('*').order('created_at', { ascending:false });
      if(state.cat!=='ì „ì²´') query = query.eq('category', state.cat);
      if(state.q) query = query.or(`word.ilike.%${state.q}%,meaning.ilike.%${state.q}%,method.ilike.%${state.q}%`);
      const { data, error } = await query;
      log('select entries â†’ '+ (error?('ERROR '+error.message):('ok '+(data?data.length:0)+' rows')) );
      if(error){ $('sys').textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: '+error.message; $('count').textContent='ì˜¤ë¥˜'; return; }
      state.entries = data || []; render();
    }

    function render(){
      $('count').textContent = 'ì´ '+state.entries.length+'ê°œ ê²°ê³¼';
      const root = $('list'); root.innerHTML='';
      for(const e of state.entries){
        const li = document.createElement('div'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:600">${esc(e.word)}</div>
              <div class="muted">${new Date(e.created_at).toLocaleString()}</div>
            </div>
            <span class="tag">${esc(e.category)}</span>
          </div>
          <div style="margin-top:8px">${esc(e.meaning)}</div>
          ${e.method?`<div class="muted" style="margin-top:4px">ë§Œë“ ë°©ë²•: ${esc(e.method)}</div>`:''}
          <div class="row" style="margin-top:8px">
            <button class="btn sec" data-edit="${e.id}">ìˆ˜ì •</button>
            <button class="btn sec" data-del="${e.id}">ì‚­ì œ</button>
          </div>
          <div id="edit-${e.id}" style="display:none;margin-top:10px">
            <div class="grid2">
              <input id="ew-${e.id}" value="${esc(e.word)}" />
              <select id="ec-${e.id}">
                ${['ìˆëŠ”ë§','ìˆë˜ë§','ë§Œë“ ë§'].map(c=>`<option ${c===e.category?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div style="margin-top:6px"><textarea id="em-${e.id}" rows="3">${esc(e.meaning)}</textarea></div>
            <div style="margin-top:6px"><input id="ed-${e.id}" value="${esc(e.method||'')}" placeholder="ë§Œë“ ë°©ë²•" /></div>
            <div class="row" style="margin-top:8px">
              <button class="btn" data-save="${e.id}">ì €ì¥</button>
              <button class="btn sec" data-cancel="${e.id}">ì·¨ì†Œ</button>
            </div>
          </div>
        `;
        root.appendChild(li);
      }
    }

    async function add(){
      const word = $('newWord').value.trim();
      const meaning = $('newMeaning').value.trim();
      const category = $('newCat').value;
      const method = $('newMethod').value.trim();
      if(!word||!meaning){ alert('ë‹¨ì–´/ëœ» í•„ìˆ˜'); return; }
      const { error } = await db.from('entries').insert([{ word, meaning, category, method }]);
      log('insert â†’ ' + (error?('ERROR '+error.message):'ok'));
      if(error){ $('sys').textContent='ì¶”ê°€ ì˜¤ë¥˜: '+error.message; return; }
      $('newWord').value=''; $('newMeaning').value=''; $('newMethod').value='';
      load();
    }

    function listClick(ev){
      const t = ev.target; const id = t.getAttribute('data-edit') || t.getAttribute('data-del') || t.getAttribute('data-save') || t.getAttribute('data-cancel');
      if(!id) return;
      if(t.hasAttribute('data-edit')){ if(!state.adminOK){alert('ë¹„ë²ˆ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”');return;} document.getElementById('edit-'+id).style.display='block'; return; }
      if(t.hasAttribute('data-cancel')){ document.getElementById('edit-'+id).style.display='none'; return; }
      if(t.hasAttribute('data-save')) return save(id);
      if(t.hasAttribute('data-del')) return del(id);
    }

    async function save(id){
      if(!state.adminOK){ alert('ë¹„ë²ˆ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”'); return; }
      const word = document.getElementById('ew-'+id).value.trim();
      const meaning = document.getElementById('em-'+id).value.trim();
      const category = document.getElementById('ec-'+id).value;
      const method = document.getElementById('ed-'+id).value.trim();
      const args = { p_id:id, p_word:word, p_meaning:meaning, p_category:category, p_method:method, p_pwd:state.adminPwd };
      const { error } = await db.rpc('entry_update_admin', args);
      log('rpc entry_update_admin â†’ ' + (error?('ERROR '+error.message):'ok'));
      if(error){ $('sys').textContent='ìˆ˜ì • ì˜¤ë¥˜: '+error.message; alert($('sys').textContent); return; }
      load();
    }

    async function del(id){
      if(!state.adminOK){ alert('ë¹„ë²ˆ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”'); return; }
      if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
      const { error } = await db.rpc('entry_delete_admin', { p_id:id, p_pwd: state.adminPwd });
      log('rpc entry_delete_admin â†’ ' + (error?('ERROR '+error.message):'ok'));
      if(error){ $('sys').textContent='ì‚­ì œ ì˜¤ë¥˜: '+error.message; alert($('sys').textContent); return; }
      load();
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.body.addEventListener('click', (ev)=>{
      if(ev.target.id==='btnVerify') verifyPwd();
      if(ev.target.id==='btnAdd') add();
      if(ev.target.id==='btnClear'){ $('newWord').value=''; $('newMeaning').value=''; $('newMethod').value=''; }
      if(ev.target.id==='btnReload') load();
    });
    $('list').addEventListener('click', listClick);
    $('q').addEventListener('input', ()=>{ clearTimeout(window._q); window._q=setTimeout(load, 250); });
    $('filterCat').addEventListener('change', load);

    setBadge();
    log('í˜ì´ì§€ ë¡œë“œ');
    // ì—°ê²° ê±´ê°• ì ê²€: í‹€ë¦° ë¹„ë²ˆìœ¼ë¡œ can_edit í•œë²ˆ í˜¸ì¶œí•´ ê²°ê³¼ í‘œì‹œ
    db.rpc('can_edit', { pwd: 'wrong' }).then(({data,error})=>{ log('warmup can_edit(wrong) â†’ data:'+data+' error:'+(error?error.message:'none')); load(); });
  })();
  </script>
</body>
</html>
