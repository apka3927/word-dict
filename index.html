<!doctype html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>단어 등록·검색 (Supabase 저장)</title>
  <!-- BUILD MARKER: WORD_CARD_BORDERS_UTILS_2025-08-25_06 -->
  <script>
    tailwind = { config: { darkMode:'class', theme:{ extend:{ fontFamily:{ sans:["Inter","Pretendard","ui-sans-serif","system-ui"] }, colors:{ brand:{600:'#2563eb',700:'#1d4ed8'} } } } } }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ color-scheme: dark }
    html,body{ height:100% }
    body{ font-family: Inter, Pretendard, ui-sans-serif, system-ui }
    /* 단색 파란 배경 */
    .page-solid{ background:#0f233d }
  </style>
</head>
<body class="min-h-full page-solid text-slate-100">
  <!-- 헤더 -->
  <header class="sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 pt-5 pb-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 grid place-items-center rounded-lg bg-brand-600 text-white">🔤</div>
          <div>
            <div id="siteTitle" class="text-lg font-semibold">단어 등록·검색 (Supabase 저장)</div>
            <div id="siteSubtitle" class="text-xs text-slate-400">원격 DB(Postgres)에 저장됩니다.</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="badge" class="inline-block text-xs px-2.5 py-1 rounded-full border-2 border-slate-600/70 bg-slate-900/80">🔒 잠금 중</span>
          <button id="btnOpenPwd" class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70">관리자</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16 pt-4">
    <div class="grid md:grid-cols-3 gap-6">
      <!-- 등록 -->
      <section class="rounded-xl border-2 border-slate-600/70 bg-slate-900/70 backdrop-blur px-5 py-4 md:col-span-1">
        <h2 id="secAdd" class="font-semibold">단어 등록</h2>
        <div class="mt-3 grid gap-3">
          <label class="grid gap-1"><span id="lblWord" class="text-xs text-slate-300">단어</span>
            <input id="newWord" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40" placeholder="예: 빗모질다" />
          </label>
          <label class="grid gap-1"><span id="lblMeaning" class="text-xs text-slate-300">뜻</span>
            <textarea id="newMeaning" rows="3" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40" placeholder="예: 횡포(橫暴)하다"></textarea>
          </label>
          <label class="grid gap-1"><span id="lblCategory" class="text-xs text-slate-300">분류</span>
            <select id="newCat" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40">
              <option>있는말</option>
              <option>있던말</option>
              <option>만든말</option>
            </select>
          </label>
          <label class="grid gap-1"><span id="lblMethod" class="text-xs text-slate-300">만든방법</span>
            <input id="newMethod" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40" placeholder="예: 빗모질다 pisk-(橫) + mwǒtil-(暴) 직역"/>
          </label>
          <div class="flex gap-2">
            <button id="btnAdd" class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold bg-brand-600 text-white hover:bg-brand-700">추가</button>
            <button id="btnClear" class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70">초기화</button>
          </div>
          <p id="sysAdd" class="text-xs text-rose-400"></p>
          <p class="text-xs text-slate-300">낱말을 올리기에 앞서 <a href="https://arca.live/b/peregrini" target="_blank" rel="noopener noreferrer" class="underline text-brand-600 hover:text-brand-700">우리말 채널(arca.live/b/peregrini)</a>에 올려 이야기를 나눠봅시다.</p>
        </div>
      </section>

      <!-- 검색/목록 -->
      <section class="rounded-xl border-2 border-slate-600/70 bg-slate-900/70 backdrop-blur px-5 py-4 md:col-span-2">
        <h2 id="secSearch" class="font-semibold">검색</h2>
        <div class="mt-3 grid md:grid-cols-3 gap-3">
          <input id="q" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40 md:col-span-2" placeholder="단어/뜻/만든방법 검색…" />
          <select id="filterCat" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40">
            <option>전체</option>
            <option>있는말</option>
            <option>있던말</option>
            <option>만든말</option>
          </select>
        </div>
        <div class="mt-2 text-xs text-slate-400 flex items-center gap-2">
          <span id="count">–</span>
          <button id="btnReload" class="inline-flex items-center justify-center gap-1 rounded-lg px-2 py-1 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70">새로고침</button>
          <div class="ml-auto flex items-center gap-2">
            <button id="prevPage" class="inline-flex items-center justify-center gap-1 rounded-lg px-3 py-1 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70 disabled:opacity-40 disabled:cursor-not-allowed">이전</button>
            <span id="pageInfo">1 / 1</span>
            <button id="nextPage" class="inline-flex items-center justify-center gap-1 rounded-lg px-3 py-1 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70 disabled:opacity-40 disabled:cursor-not-allowed">다음</button>
          </div>
        </div>

        <ul id="list" class="mt-4 grid md:grid-cols-2 gap-4"></ul>
      </section>
    </div>
  </main>

  <!-- 비밀번호 모달 -->
  <div id="pwdModal" class="hidden fixed inset-0 z-40 bg-black/40 grid place-items-center p-4">
    <div class="rounded-xl border-2 border-slate-600/70 bg-slate-900/70 backdrop-blur px-5 py-4 w-full max-w-sm">
      <h3 id="modalTitle" class="font-semibold">관리자 비밀번호</h3>
      <input id="pwd" type="password" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40 mt-3" placeholder="••••••" />
      <div class="flex gap-2 mt-4">
        <button id="btnVerify" class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold bg-brand-600 text-white hover:bg-brand-700">확인</button>
        <button id="btnClosePwd" class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70">닫기</button>
      </div>
      <p id="sysPwd" class="text-xs text-rose-400 mt-2"></p>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <script>
  (function(){
    const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === UI 텍스트 중앙 관리 ===
    const UI = {
      title: "단어 등록 및 검색 (Supabase 저장)",
      subtitle: "원격 DB(Postgres)에 저장됩니다.",
      sections: { add: "단어 등록", search: "검색", adminPwd: "관리자 비밀번호" },
      terms: { word: "단어", meaning: "뜻", category: "분류", method: "만든방법" },
      buttons: { add:"추가", clear:"초기화", admin:"관리자", reload:"새로고침", prev:"이전", next:"다음", edit:"수정", delete:"삭제", save:"저장", cancel:"취소", verify:"확인", close:"닫기" },
      placeholders: { word:"예: 빗모질다", meaning:"예: 횡포(橫暴)하다", method:"예: 빗모질다 pisk-(橫) + mwǒtil-(暴) 직역", search:"단어/뜻/만든방법 검색…" },
      // ⚠ DB 제약과 맞춰야 하므로 value는 그대로 두고, label만 바꾸세요.
      cats: [
        { value:"전체", label:"전체" },
        { value:"있는말", label:"있는말" },
        { value:"있던말", label:"있던말" },
        { value:"만든말", label:"만든말" },
      ],
      messages: {
        loading:"불러오는 중…",
        total:(t,p,ps)=>`총 ${t}개 중 ${p}/${ps}페이지`,
        needWordMeaning:"단어/뜻은 필수입니다.",
        adminLocked:"🔒 잠금 중",
        adminUnlocked:"🔓 관리자 모드",
        adminActivated:"관리자 모드 활성화",
        needAdmin:"먼저 관리자 인증을 해주세요",
        deleteConfirm:"정말 삭제할까요?",
        error:"오류"
      }
    };

    function catLabel(v){ const f = UI.cats.find(c=>c.value===v); return f?f.label:v; }

    function applyUI(){
      document.title = UI.title;
      const st = document.getElementById('siteTitle'); if(st) st.textContent = UI.title;
      const ss = document.getElementById('siteSubtitle'); if(ss) ss.textContent = UI.subtitle;
      const sa = document.getElementById('secAdd'); if(sa) sa.textContent = UI.sections.add;
      const ss2 = document.getElementById('secSearch'); if(ss2) ss2.textContent = UI.sections.search;
      const mt = document.getElementById('modalTitle'); if(mt) mt.textContent = UI.sections.adminPwd;
      const mapLabels = { lblWord: UI.terms.word, lblMeaning:UI.terms.meaning, lblCategory:UI.terms.category, lblMethod:UI.terms.method };
      Object.entries(mapLabels).forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.textContent = txt; });
      const p = { newWord:UI.placeholders.word, newMeaning:UI.placeholders.meaning, newMethod:UI.placeholders.method, q:UI.placeholders.search };
      Object.entries(p).forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.placeholder = txt; });
      const b = { btnAdd:UI.buttons.add, btnClear:UI.buttons.clear, btnOpenPwd:UI.buttons.admin, btnReload:UI.buttons.reload, prevPage:UI.buttons.prev, nextPage:UI.buttons.next, btnVerify:UI.buttons.verify, btnClosePwd:UI.buttons.close };
      Object.entries(b).forEach(([id,txt])=>{ const el=document.getElementById(id); if(el) el.textContent = txt; });
      const filter=document.getElementById('filterCat'); if(filter){ filter.innerHTML = UI.cats.map(c=>`<option value="${c.value}">${c.label}</option>`).join(''); }
      const newCat=document.getElementById('newCat'); if(newCat){ newCat.innerHTML = UI.cats.filter(c=>c.value!=='전체').map(c=>`<option value="${c.value}">${c.label}</option>`).join(''); }
      setBadge();
    }

    const state = { adminOK:false, adminPwd:'', q:'', cat:'전체', page:1, limit:50, total:0, pages:1, entries:[] };
    const $ = (s)=>document.querySelector(s);

    // 공통 클래스(카드/배지)
    const CARD = 'rounded-xl border-2 border-slate-600/70 bg-slate-900/70 backdrop-blur px-5 py-4';
    const PILL = 'inline-block text-xs px-2.5 py-1 rounded-full border-2 border-slate-600/70 bg-slate-900/80';

    function toast(msg,type='ok'){ const el=document.createElement('div'); el.className=`rounded-lg px-3 py-2 text-sm ${type==='ok'?'bg-brand-600 text-white':'bg-rose-600 text-white'}`; el.textContent=msg; $('#toasts').appendChild(el); setTimeout(()=>el.remove(),1600); }
    function setBadge(){ $('#badge').textContent = state.adminOK? UI.messages.adminUnlocked : UI.messages.adminLocked; }

    const openPwd = ()=>$('#pwdModal').classList.remove('hidden');
    const closePwd = ()=>$('#pwdModal').classList.add('hidden');
    $('#btnOpenPwd').addEventListener('click', openPwd); $('#btnClosePwd').addEventListener('click', closePwd);
    $('#btnVerify').addEventListener('click', verifyPwd);

    async function verifyPwd(){
      $('#sysPwd').textContent=''; const value=$('#pwd').value; if(!value){ $('#sysPwd').textContent='비밀번호를 입력하세요.'; return; }
      const { data, error } = await db.rpc('can_edit', { pwd: value });
      if(error){ $('#sysPwd').textContent=error.message; state.adminOK=false; setBadge(); return; }
      if(!data){ $('#sysPwd').textContent='틀렸습니다.'; state.adminOK=false; setBadge(); return; }
      state.adminOK=true; state.adminPwd=value; setBadge(); closePwd(); toast(UI.messages.adminActivated);
    }

    async function load(){
      state.q = $('#q').value.trim();
      state.cat = $('#filterCat').value;
      $('#count').textContent = UI.messages.loading;
      const from = (state.page-1) * state.limit;
      const to = from + state.limit - 1;
      let query = db.from('entries')
        .select('*', { count: 'exact' })
        .order('created_at',{ascending:false})
        .range(from, to);
      if(state.cat!=='전체') query = query.eq('category', state.cat);
      if(state.q) query = query.or(`word.ilike.%${state.q}%,meaning.ilike.%${state.q}%,method.ilike.%${state.q}%`);
      const { data, count, error } = await query;
      if(error){ $('#count').textContent = UI.messages.error; toast(error.message,'err'); return; }
      state.entries = data||[];
      state.total = count ?? state.entries.length;
      state.pages = Math.max(1, Math.ceil((state.total||0)/state.limit));
      $('#count').textContent = UI.messages.total(state.total, state.page, state.pages);
      const pageInfo = $('#pageInfo'); if(pageInfo) pageInfo.textContent = `${state.page} / ${state.pages}`;
      const prev = $('#prevPage'), next = $('#nextPage');
      if(prev) prev.disabled = state.page<=1;
      if(next) next.disabled = state.page>=state.pages;
      renderList();
    }

    function esc(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function escAttr(s=''){ return esc(s).replace(/\n/g,' '); }

    function renderList(){
      const root=$('#list'); root.innerHTML='';
      for(const e of state.entries){
        const li=document.createElement('li');
        li.className = CARD; // ▶ 리스트 항목을 ‘카드’로 명확히 보이게
        li.innerHTML=`
          <div class="flex items-start justify-between">
            <div>
              <div class="text-base font-semibold">${esc(e.word)}</div>
              <div class="text-xs text-slate-400">${new Date(e.created_at).toLocaleString()}</div>
            </div>
            <span class="${PILL}">${esc(catLabel(e.category))}</span>
          </div>
          <div class="mt-3 text-sm whitespace-pre-wrap">${esc(e.meaning)}</div>
          ${e.method?`<div class="mt-2 text-xs text-slate-400">${UI.terms.method}: ${esc(e.method)}</div>`:''}
          <div class="h-px bg-slate-700/80 my-3"></div>
          <div class="flex gap-2 justify-end">
            <button class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70" data-edit="${e.id}">${UI.buttons.edit}</button>
            <button class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70" data-del="${e.id}">${UI.buttons.delete}</button>
          </div>
          <div id="edit-${e.id}" class="hidden mt-3 grid gap-2">
            <div class="grid md:grid-cols-2 gap-2">
              <input id="ew-${e.id}" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40" value="${escAttr(e.word)}" />
              <select id="ec-${e.id}" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40">${['있는말','있던말','만든말'].map(c=>`<option ${c===e.category?'selected':''}>${c}</option>`).join('')}</select>
            </div>
            <textarea id="em-${e.id}" rows="3" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40">${esc(e.meaning)}</textarea>
            <input id="ed-${e.id}" class="w-full rounded-lg border-2 border-slate-600/70 bg-slate-900/90 text-slate-100 px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600/40" value="${escAttr(e.method||'')}" placeholder="${UI.terms.method}" />
            <div class="flex gap-2 justify-end">
              <button class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold bg-brand-600 text-white hover:bg-brand-700" data-save="${e.id}">${UI.buttons.save}</button>
              <button class="inline-flex items-center justify-center gap-1 rounded-lg px-4 py-2 text-sm font-semibold border-2 border-slate-600/70 bg-slate-900/70 hover:bg-slate-800/70" data-cancel="${e.id}">${UI.buttons.cancel}</button>
            </div>
          </div>`;
        root.appendChild(li);
      }
    }

    document.addEventListener('click',(ev)=>{
      const t=ev.target; const id=t.getAttribute('data-edit')||t.getAttribute('data-del')||t.getAttribute('data-save')||t.getAttribute('data-cancel'); if(!id) return;
      if(t.hasAttribute('data-edit')){ if(!state.adminOK){ toast(UI.messages.needAdmin,'err'); return; } document.getElementById('edit-'+id).classList.remove('hidden'); return; }
      if(t.hasAttribute('data-cancel')){ document.getElementById('edit-'+id).classList.add('hidden'); return; }
      if(t.hasAttribute('data-save')) return saveEdit(id);
      if(t.hasAttribute('data-del')) return removeEntry(id);
    });

    async function saveEdit(id){ if(!state.adminOK){ toast(UI.messages.needAdmin,'err'); return; }
      const word=document.getElementById('ew-'+id).value.trim(); const meaning=document.getElementById('em-'+id).value.trim(); const category=document.getElementById('ec-'+id).value; const method=document.getElementById('ed-'+id).value.trim(); if(!word||!meaning){ toast(UI.messages.needWordMeaning,'err'); return; }
      const { error }=await db.rpc('entry_update_admin',{ p_id:id,p_word:word,p_meaning:meaning,p_category:category,p_method:method,p_pwd:state.adminPwd }); if(error){ toast('수정 오류: '+error.message,'err'); return; } toast('수정 완료'); load(); }

    async function removeEntry(id){ if(!state.adminOK){ toast(UI.messages.needAdmin,'err'); return; } if(!confirm(UI.messages.deleteConfirm)) return; const { error }=await db.rpc('entry_delete_admin',{ p_id:id,p_pwd:state.adminPwd }); if(error){ toast('삭제 오류: '+error.message,'err'); return; } toast('삭제 완료'); load(); }

    async function addEntry(){ const word=$('#newWord').value.trim(); const meaning=$('#newMeaning').value.trim(); const category=$('#newCat').value; const method=$('#newMethod').value.trim(); if(!word||!meaning){ $('#sysAdd').textContent='단어/뜻은 필수입니다.'; return; } const { error }=await db.from('entries').insert([{ word,meaning,category,method }]); if(error){ $('#sysAdd').textContent='추가 오류: '+error.message; return; } $('#sysAdd').textContent=''; $('#newWord').value=''; $('#newMeaning').value=''; $('#newMethod').value=''; toast('추가 완료'); load(); }

    $('#btnAdd').addEventListener('click', addEntry);
    $('#btnClear').addEventListener('click', ()=>{ $('#newWord').value=''; $('#newMeaning').value=''; $('#newMethod').value=''; });
    $('#btnReload').addEventListener('click', load);

    $('#q').addEventListener('input', () => {
      clearTimeout(window._q);
      window._q = setTimeout(() => { state.page=1; load(); }, 250);
    });

    $('#filterCat').addEventListener('change', () => { state.page=1; load(); });

    applyUI();

    $('#prevPage').addEventListener('click', ()=>{ if(state.page>1){ state.page--; load(); }});
    $('#nextPage').addEventListener('click', ()=>{ if(state.page<state.pages){ state.page++; load(); }});

    load();
  })();
  </script>
</body>
</html>
