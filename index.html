<!doctype html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìš°ë¦¬ë§ì±ˆ ë‚±ë§ëª¨ì´</title>
  <!-- BUILD MARKER: PAGED50_ERRORSAFE_2025-08-25_07 -->
  <script>
    tailwind = { config: { darkMode:'class', theme:{ extend:{ fontFamily:{ sans:["Inter","Pretendard","ui-sans-serif","system-ui"] }, colors:{ brand:{600:'#2563eb',700:'#1d4ed8'} } } } } }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ color-scheme: dark }
    html,body{ height:100% }
    body{ font-family: Inter, Pretendard, ui-sans-serif, system-ui }
    .page-solid{ background:#0f233d }
    .CARD{ border-width:2px; border-color:rgba(71,85,105,.7); background-color:rgba(15,23,42,.7); border-radius:0.75rem; padding:1rem 1.25rem; backdrop-filter:blur(4px) }
    .PILL{ display:inline-block; font-size:.75rem; padding:.25rem .625rem; border-radius:9999px; border:2px solid rgba(71,85,105,.7); background:rgba(15,23,42,.8) }
    .INPUT{ width:100%; border-radius:.5rem; border:2px solid rgba(71,85,105,.7); background:rgba(15,23,42,.9); color:#e2e8f0; padding:.5rem .75rem; font-size:.875rem; outline:none }
    .INPUT:focus{ border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,.25) inset }
    .BTN{ display:inline-flex; align-items:center; justify-content:center; gap:.25rem; border-radius:.5rem; padding:.5rem 1rem; font-weight:600; font-size:.875rem }
    .BTN-GHOST{ border:2px solid rgba(71,85,105,.7); background:rgba(15,23,42,.7) }
    .BTN-GHOST:hover{ background:rgba(30,41,59,.7) }
    .BTN-PRI{ background:#2563eb; color:#fff }
    .BTN-PRI:hover{ background:#1d4ed8 }
  </style>
</head>
<body class="min-h-full page-solid text-slate-100">
  <header class="sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 pt-5 pb-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 grid place-items-center rounded-lg bg-brand-600 text-white">ğŸ”¤</div>
          <div>
            <div class="text-lg font-semibold">ìš°ë¦¬ë§ì±ˆ ë‚±ë§ëª¨ì´</div>
            <div class="text-xs text-slate-400">ì›ê²© DB(Postgres)ì— ê°Šì•„ì§‘ë‹ˆë‹¤.</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="badge" class="PILL">ğŸ”’ ì ê¸ˆ ì¤‘</span>
          <button id="btnOpenPwd" class="BTN BTN-GHOST">ê°€ë§ì´</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16 pt-4">
    <div class="grid md:grid-cols-3 gap-6">
      <!-- ë“±ë¡ -->
      <section class="CARD md:col-span-1">
        <h2 class="font-semibold">ë‚±ë§ ë“±ë¡</h2>
        <div class="mt-3 grid gap-3">
          <label class="grid gap-1"><span class="text-xs text-slate-300">ë‚±ë§</span>
            <input id="newWord" class="INPUT" placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤" />
          </label>
          <label class="grid gap-1"><span class="text-xs text-slate-300">ëœ»</span>
            <textarea id="newMeaning" rows="3" class="INPUT" placeholder="ì˜ˆ: íš¡í¬(æ©«æš´)í•˜ë‹¤"></textarea>
          </label>
          <label class="grid gap-1"><span class="text-xs text-slate-300">ë¶„ë¥˜</span>
            <select id="newCat" class="INPUT">
              <option>ìˆëŠ”ë§</option>
              <option>ìˆë˜ë§</option>
              <option>ë§Œë“ ë§</option>
            </select>
          </label>
          <label class="grid gap-1"><span class="text-xs text-slate-300">ë§Œë“ ë°©ë²•</span>
            <input id="newMethod" class="INPUT" placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤ pisk-(æ©«) + mwÇ’til-(æš´) ì§ì—­"/>
          </label>
          <div class="flex gap-2">
            <button id="btnAdd" class="BTN BTN-PRI">ì˜¬ë¦¬ê¸°</button>
            <button id="btnClear" class="BTN BTN-GHOST">ì• ê»˜ë¡œ</button>
          </div>
          <p id="sysAdd" class="text-xs text-rose-400"></p>
          <p class="text-xs text-slate-300">ë‚±ë§ì„ ì˜¬ë¦¬ê¸°ì— ì•ì„œ <a href="https://arca.live/b/peregrini" target="_blank" rel="noopener noreferrer" class="underline text-brand-600 hover:text-brand-700">ìš°ë¦¬ë§ ì±„ë„(arca.live/b/peregrini)</a>ì— ì˜¬ë ¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë´…ì‹œë‹¤.</p>
        </div>
      </section>

      <!-- ê²€ìƒ‰/ëª©ë¡ -->
      <section class="CARD md:col-span-2">
        <h2 class="font-semibold">ì°¾ê¸°</h2>
        <div class="mt-3 grid md:grid-cols-3 gap-3">
          <input id="q" class="INPUT md:col-span-2" placeholder="ë‚±ë§/ëœ»/ë§Œë“ ë°©ë²• ì°¾ê¸°â€¦" />
          <select id="filterCat" class="INPUT">
            <option>ëª¨ë‘</option>
            <option>ìˆëŠ”ë§</option>
            <option>ìˆë˜ë§</option>
            <option>ë§Œë“ ë§</option>
          </select>
        </div>
        <div class="mt-2 text-xs text-slate-400 flex items-center gap-2">
          <span id="count">â€“</span>
          <button id="btnReload" class="BTN BTN-GHOST px-2 py-1">ìƒˆë¡œê³ ì¹¨</button>
          <div class="ml-auto flex items-center gap-2">
            <button id="prevPage" class="BTN BTN-GHOST px-3 py-1 disabled:opacity-40 disabled:cursor-not-allowed">ì´ì „</button>
            <span id="pageInfo">1 / 1</span>
            <button id="nextPage" class="BTN BTN-GHOST px-3 py-1 disabled:opacity-40 disabled:cursor-not-allowed">ë‹¤ìŒ</button>
          </div>
        </div>

        <ul id="list" class="mt-4 grid md:grid-cols-2 gap-4"></ul>
      </section>
    </div>
  </main>

  <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="pwdModal" class="hidden fixed inset-0 z-40 bg-black/40 grid place-items-center p-4">
    <div class="CARD w-full max-w-sm">
      <h3 class="font-semibold">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
      <input id="pwd" type="password" class="INPUT mt-3" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <div class="flex gap-2 mt-4">
        <button id="btnVerify" class="BTN BTN-PRI">í™•ì¸</button>
        <button id="btnClosePwd" class="BTN BTN-GHOST">ë‹«ê¸°</button>
      </div>
      <p id="sysPwd" class="text-xs text-rose-400 mt-2"></p>
    </div>
  </div>

  <div id="toasts" class="fixed top-4 right-4 space-y-2 z-50"></div>

  <script>
  (function(){
    const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { adminOK:false, adminPwd:'', q:'', cat:'ì „ì²´', page:1, limit:50, total:0, pages:1, entries:[] };
    const $ = (s)=>document.querySelector(s);

    function toast(msg,type='ok'){
      const el=document.createElement('div'); el.className=`rounded-lg px-3 py-2 text-sm ${type==='ok'?'bg-brand-600 text-white':'bg-rose-600 text-white'}`; el.textContent=msg; $('#toasts').appendChild(el); setTimeout(()=>el.remove(),1600);
    }
    function setBadge(){ $('#badge').textContent = state.adminOK? 'ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ' : 'ğŸ”’ ì ê¸ˆ ì¤‘'; }

    const openPwd = ()=>$('#pwdModal').classList.remove('hidden');
    const closePwd = ()=>$('#pwdModal').classList.add('hidden');
    $('#btnOpenPwd').addEventListener('click', openPwd); $('#btnClosePwd').addEventListener('click', closePwd);
    $('#btnVerify').addEventListener('click', verifyPwd);

    async function verifyPwd(){
      $('#sysPwd').textContent=''; const value=$('#pwd').value; if(!value){ $('#sysPwd').textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
      const { data, error } = await db.rpc('can_edit', { pwd: value });
      if(error){ $('#sysPwd').textContent=error.message; state.adminOK=false; setBadge(); return; }
      if(!data){ $('#sysPwd').textContent='í‹€ë ¸ìŠµë‹ˆë‹¤.'; state.adminOK=false; setBadge(); return; }
      state.adminOK=true; state.adminPwd=value; setBadge(); closePwd(); toast('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”');
    }

    async function load(){
      try{
        state.q = $('#q').value.trim();
        state.cat = $('#filterCat').value;
        const from = (state.page-1) * state.limit;
        const to = from + state.limit - 1;
        $('#count').textContent='ë¶ˆëŸ¬ì˜¤ê³  ìˆìŒâ€¦';
        let query = db.from('entries')
          .select('*', { count: 'exact', head: false })
          .order('created_at', { ascending:false })
          .range(from, to);
        if(state.cat!=='ì „ì²´') query = query.eq('category', state.cat);
        if(state.q) query = query.or(`word.ilike.%${state.q}%,meaning.ilike.%${state.q}%,method.ilike.%${state.q}%`);
        const { data, count, error } = await query;
        if(error) throw error;
        state.entries = data || [];
        state.total = (typeof count === 'number') ? count : state.entries.length;
        state.pages = Math.max(1, Math.ceil(state.total / state.limit));
        $('#count').textContent = `ì´ ${state.total}ê°œ ì¤‘ ${state.page}/${state.pages}í˜ì´ì§€`;
        const pageInfo = $('#pageInfo'); if(pageInfo) pageInfo.textContent = `${state.page} / ${state.pages}`;
        const prev = $('#prevPage'), next = $('#nextPage');
        if(prev) prev.disabled = state.page<=1;
        if(next) next.disabled = state.page>=state.pages;
        renderList();
      }catch(err){
        console.error(err);
        $('#count').textContent = 'ì˜¤ë¥˜: '+(err?.message||err);
        const root=$('#list'); if(root) root.innerHTML='';
      }
    }

    function esc(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function escAttr(s=''){ return esc(s).replace(/\n/g,' '); }

    function renderList(){
      const root=$('#list'); root.innerHTML='';
      for(const e of state.entries){
        const li=document.createElement('li'); li.className='CARD';
        li.innerHTML=`
          <div class="flex items-start justify-between">
            <div>
              <div class="text-base font-semibold">${esc(e.word)}</div>
              <div class="text-xs text-slate-400">${new Date(e.created_at).toLocaleString()}</div>
            </div>
            <span class="PILL">${esc(e.category)}</span>
          </div>
          <div class="mt-3 text-sm whitespace-pre-wrap">${esc(e.meaning)}</div>
          ${e.method?`<div class=\"mt-2 text-xs text-slate-400\">ë§Œë“ ë°©ë²•: ${esc(e.method)}</div>`:''}
          <div class="h-px bg-slate-700/80 my-3"></div>
          <div class="flex gap-2 justify-end">
            <button class="BTN BTN-GHOST" data-edit="${e.id}">ìˆ˜ì •</button>
            <button class="BTN BTN-GHOST" data-del="${e.id}">ì‚­ì œ</button>
          </div>
          <div id="edit-${e.id}" class="hidden mt-3 grid gap-2">
            <div class="grid md:grid-cols-2 gap-2">
              <input id="ew-${e.id}" class="INPUT" value="${escAttr(e.word)}" />
              <select id="ec-${e.id}" class="INPUT">${['ìˆëŠ”ë§','ìˆë˜ë§','ë§Œë“ ë§'].map(c=>`<option ${c===e.category?'selected':''}>${c}</option>`).join('')}</select>
            </div>
            <textarea id="em-${e.id}" rows="3" class="INPUT">${esc(e.meaning)}</textarea>
            <input id="ed-${e.id}" class="INPUT" value="${escAttr(e.method||'')}" placeholder="ë§Œë“ ë°©ë²•" />
            <div class="flex gap-2 justify-end">
              <button class="BTN BTN-PRI" data-save="${e.id}">ì €ì¥</button>
              <button class="BTN BTN-GHOST" data-cancel="${e.id}">ì·¨ì†Œ</button>
            </div>
          </div>`;
        root.appendChild(li);
      }
    }

    document.addEventListener('click',(ev)=>{
      const t=ev.target; const id=t.getAttribute('data-edit')||t.getAttribute('data-del')||t.getAttribute('data-save')||t.getAttribute('data-cancel'); if(!id) return;
      if(t.hasAttribute('data-edit')){ if(!state.adminOK){ toast('ë¨¼ì € ê´€ë¦¬ì ì¸ì¦ì„ í•´ì£¼ì„¸ìš”','err'); return; } document.getElementById('edit-'+id).classList.remove('hidden'); return; }
      if(t.hasAttribute('data-cancel')){ document.getElementById('edit-'+id).classList.add('hidden'); return; }
      if(t.hasAttribute('data-save')) return saveEdit(id);
      if(t.hasAttribute('data-del')) return removeEntry(id);
    });

    async function saveEdit(id){ if(!state.adminOK){ toast('ë¨¼ì € ê´€ë¦¬ì ì¸ì¦ì„ í•´ì£¼ì„¸ìš”','err'); return; }
      const word=document.getElementById('ew-'+id).value.trim(); const meaning=document.getElementById('em-'+id).value.trim(); const category=document.getElementById('ec-'+id).value; const method=document.getElementById('ed-'+id).value.trim(); if(!word||!meaning){ toast('ë‚±ë§/ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤','err'); return; }
      const { error }=await db.rpc('entry_update_admin',{ p_id:id,p_word:word,p_meaning:meaning,p_category:category,p_method:method,p_pwd:state.adminPwd }); if(error){ toast('ìˆ˜ì • ì˜¤ë¥˜: '+error.message,'err'); return; } toast('ìˆ˜ì • ì™„ë£Œ'); load(); }

    async function removeEntry(id){ if(!state.adminOK){ toast('ë¨¼ì € ê´€ë¦¬ì ì¸ì¦ì„ í•´ì£¼ì„¸ìš”','err'); return; } if(!confirm('ì•„ì£¼ ì§€ìš¸ê¹Œìš”?')) return; const { error }=await db.rpc('entry_delete_admin',{ p_id:id,p_pwd:state.adminPwd }); if(error){ toast('ì‚­ì œ ì˜¤ë¥˜: '+error.message,'err'); return; } toast('ì‚­ì œ ì™„ë£Œ'); load(); }

    async function addEntry(){ const word=$('#newWord').value.trim(); const meaning=$('#newMeaning').value.trim(); const category=$('#newCat').value; const method=$('#newMethod').value.trim(); if(!word||!meaning){ $('#sysAdd').textContent='ë‚±ë§/ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'; return; } const { error }=await db.from('entries').insert([{ word,meaning,category,method }]); if(error){ $('#sysAdd').textContent='ì¶”ê°€ ì˜¤ë¥˜: '+error.message; return; } $('#sysAdd').textContent=''; $('#newWord').value=''; $('#newMeaning').value=''; $('#newMethod').value=''; toast('ì¶”ê°€ ì™„ë£Œ'); load(); }

    $('#btnAdd').addEventListener('click', addEntry); $('#btnClear').addEventListener('click', ()=>{ $('#newWord').value=''; $('#newMeaning').value=''; $('#newMethod').value=''; }); $('#btnReload').addEventListener('click', load); $('#q').addEventListener('input', ()=>{ clearTimeout(window._q); window._q=setTimeout(()=>{ state.page=1; load(); },250); }); $('#filterCat').addEventListener('change', ()=>{ state.page=1; load(); });

    const prevEl=$('#prevPage'), nextEl=$('#nextPage');
    if(prevEl) prevEl.addEventListener('click', ()=>{ if(state.page>1){ state.page--; load(); }});
    if(nextEl) nextEl.addEventListener('click', ()=>{ if(state.page<state.pages){ state.page++; load(); }});

    setBadge(); load();
  })();
  </script>
</body>
</html>
