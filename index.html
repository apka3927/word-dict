<!doctype html>
<html lang="ko" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë‹¨ì–´ ì‚¬ì „ â€” ì‚­ì œ/ìˆ˜ì • í•«í”½ìŠ¤</title>
    <script>tailwind = { config: { darkMode: 'class' } };</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body class="h-full">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useState } = React;
      const CATEGORIES = ["ìˆëŠ”ë§", "ìˆë˜ë§", "ë§Œë“ ë§"];

      // ì‚¬ìš©ì í”„ë¡œì íŠ¸ ì—°ê²°ê°’ (ë™ì¼)
      const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";
      const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function App(){
        const [dark, setDark] = useState(() => matchMedia('(prefers-color-scheme: dark)').matches);
        useEffect(()=>{ document.documentElement.classList.toggle('dark', dark); }, [dark]);

        const [entries, setEntries] = useState([]);
        const [loading, setLoading] = useState(true);
        const [q, setQ] = useState('');
        const [cat, setCat] = useState('ì „ì²´');
        const [err, setErr] = useState('');
        const [busy, setBusy] = useState(false);

        // ë“±ë¡ í¼
        const [form, setForm] = useState({word:'', meaning:'', category:CATEGORIES[0], method:''});

        // í¸ì§‘ ìƒíƒœ
        const [editingId, setEditingId] = useState(null);
        const [edit, setEdit] = useState({word:'', meaning:'', category:CATEGORIES[0], method:''});

        // ğŸ” ê´€ë¦¬ì ë¹„ë²ˆ ë³´ê´€ + ì ê¸ˆ ìƒíƒœ
        const [adminPwd, setAdminPwd] = useState('');
        const [adminOK, setAdminOK] = useState(false);
        const [showPwd, setShowPwd] = useState(false);

        async function load(){
          setLoading(true); setErr('');
          try{
            const term = q.trim();
            let query = db.from('entries').select('*').order('created_at',{ascending:false});
            if(cat!=='ì „ì²´') query = query.eq('category', cat);
            if(term) query = query.or(`word.ilike.%${term}%,meaning.ilike.%${term}%,method.ilike.%${term}%`);
            const { data, error } = await query;
            if(error) throw error; setEntries(data||[]);
          }catch(e){ setErr(e.message||String(e)); }
          finally{ setLoading(false); }
        }
        useEffect(()=>{ load(); },[]);
        useEffect(()=>{ const t=setTimeout(load,250); return ()=>clearTimeout(t); },[q,cat]);

        async function addEntry(){
          const {word, meaning, category, method} = form;
          if(!word.trim()||!meaning.trim()) return alert('ë‹¨ì–´/ëœ» í•„ìˆ˜');
          setBusy(true);
          try{
            const { error } = await db.from('entries').insert([{word:word.trim(), meaning:meaning.trim(), category, method:(method||'').trim()}]);
            if(error) throw error; setForm({word:'', meaning:'', category, method:''}); await load();
          }catch(e){ alert('ì €ì¥ ì˜¤ë¥˜: '+(e.message||e)); }
          finally{ setBusy(false); }
        }

        // ğŸ” ë¹„ë²ˆ í™•ì¸ â†’ ì„œë²„ í•¨ìˆ˜(can_edit)ë¡œ ì‹¤ì œ ê²€ì¦
        async function verifyPwd(){
          if(!adminPwd) { alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
          setBusy(true);
          try{
            const { data, error } = await db.rpc('can_edit', { pwd: adminPwd });
            console.log('[RPC can_edit] data:', data, 'error:', error);
            if(error) throw error;
            if(!data) { setAdminOK(false); alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }
            setAdminOK(true);
            alert('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”');
          }catch(e){ alert('ê²€ì¦ ì˜¤ë¥˜: '+(e.message||e)); }
          finally{ setBusy(false); }
        }

        function requireAdmin(){ if(!adminOK){ alert('ë¨¼ì € ë¹„ë°€ë²ˆí˜¸ë¡œ ê´€ë¦¬ì ëª¨ë“œë¥¼ ì¼œì„¸ìš”.'); return false; } return true; }

        function beginEdit(e){ if(!requireAdmin()) return; setEditingId(e.id); setEdit({word:e.word, meaning:e.meaning, category:e.category, method:e.method||''}); }
        function cancelEdit(){ setEditingId(null); }

        async function saveEdit(){
          if(!requireAdmin()) return;
          const {word, meaning, category, method} = edit;
          if(!word.trim()||!meaning.trim()) return alert('ë‹¨ì–´/ëœ» í•„ìˆ˜');
          setBusy(true);
          try{
            // âœ… ì¼ë°˜ update() ê¸ˆì§€. ë°˜ë“œì‹œ RPCë§Œ ì‚¬ìš©.
            const payload = { p_id: editingId, p_word: word.trim(), p_meaning: meaning.trim(), p_category: category, p_method: (method||'').trim(), p_pwd: adminPwd };
            console.log('[RPC entry_update_admin] args:', payload);
            const { data, error } = await db.rpc('entry_update_admin', payload);
            console.log('[RPC entry_update_admin] data:', data, 'error:', error);
            if(error) throw error;
            setEditingId(null); await load(); alert('ìˆ˜ì • ì™„ë£Œ');
          }catch(e){ console.error(e); alert('ìˆ˜ì • ì˜¤ë¥˜: '+(e.message||e)); }
          finally{ setBusy(false); }
        }

        async function removeEntry(id){
          if(!requireAdmin()) return;
          if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
          setBusy(true);
          try{
            const payload = { p_id: id, p_pwd: adminPwd };
            console.log('[RPC entry_delete_admin] args:', payload);
            const { data, error } = await db.rpc('entry_delete_admin', payload);
            console.log('[RPC entry_delete_admin] data:', data, 'error:', error);
            if(error) throw error;
            await load(); alert('ì‚­ì œ ì™„ë£Œ');
          }catch(e){ console.error(e); alert('ì‚­ì œ ì˜¤ë¥˜: '+(e.message||e)); }
          finally{ setBusy(false); }
        }

        return (
          <div className="min-h-screen bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100">
            <header className="sticky top-0 z-10 border-b border-slate-200/60 dark:border-slate-800/60 bg-white/70 dark:bg-slate-900/70 backdrop-blur">
              <div className="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
                <div className="font-semibold">ë‹¨ì–´ ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì • â€” í•«í”½ìŠ¤</div>
                <div className="flex items-center gap-2">
                  <div className="flex items-center gap-2 border rounded-xl px-2 py-1">
                    <input type={showPwd? 'text':'password'} className="outline-none bg-transparent text-sm" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" value={adminPwd} onChange={e=>setAdminPwd(e.target.value)} />
                    <button className="text-xs" onClick={()=>setShowPwd(s=>!s)}>{showPwd?'ìˆ¨ê¹€':'í‘œì‹œ'}</button>
                    <button className="px-2 py-1 rounded bg-emerald-600 text-white text-xs" onClick={verifyPwd} disabled={busy}>í™•ì¸</button>
                  </div>
                  <span className={`text-xs px-2 py-1 rounded ${adminOK? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300':'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300'}`}>{adminOK? 'ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ':'ğŸ”’ ì ê¸ˆ ì¤‘'}</span>
                  <button className="px-3 py-1.5 rounded border text-sm" onClick={()=>setDark(d=>!d)}>{dark?'ğŸŒ™':'â˜€ï¸'}</button>
                </div>
              </div>
            </header>

            <main className="mx-auto max-w-5xl px-4 py-6 grid lg:grid-cols-3 gap-6">
              <section className="lg:col-span-1 p-5 rounded-2xl border dark:border-slate-800">
                <h2 className="font-semibold">ë‹¨ì–´ ë“±ë¡</h2>
                <div className="mt-3 grid gap-3">
                  <Field label="ë‹¨ì–´"><input value={form.word} onChange={e=>setForm({...form, word:e.target.value})} className="input" placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤"/></Field>
                  <Field label="ëœ»"><textarea rows=3 value={form.meaning} onChange={e=>setForm({...form, meaning:e.target.value})} className="input" placeholder="ì˜ˆ: íš¡í¬(æ©«æš´)í•˜ë‹¤"/></Field>
                  <Field label="ë¶„ë¥˜"><select value={form.category} onChange={e=>setForm({...form, category:e.target.value})} className="input">{CATEGORIES.map(c=> <option key={c} value={c}>{c}</option>)}</select></Field>
                  <Field label="ë§Œë“ ë°©ë²•"><input value={form.method} onChange={e=>setForm({...form, method:e.target.value})} className="input" placeholder="ì˜ˆ: pisk-(æ©«) + mwÇ’til-(æš´) ì§ì—­"/></Field>
                  <div className="flex gap-2">
                    <button className="btn" disabled={busy} onClick={addEntry}>ì¶”ê°€</button>
                    <button className="btn-outline" onClick={()=>setForm({word:'', meaning:'', category:form.category, method:''})}>ì´ˆê¸°í™”</button>
                  </div>
                </div>
                {err && <p className="mt-3 text-xs text-rose-600">ì˜¤ë¥˜: {err}</p>}
              </section>

              <section className="lg:col-span-2 space-y-4">
                <div className="p-5 rounded-2xl border dark:border-slate-800">
                  <h2 className="font-semibold">ê²€ìƒ‰</h2>
                  <div className="mt-3 grid md:grid-cols-3 gap-3">
                    <input className="input md:col-span-2" placeholder="ë‹¨ì–´/ëœ»/ë§Œë“ ë°©ë²• ê²€ìƒ‰" value={q} onChange={e=>setQ(e.target.value)} />
                    <select className="input" value={cat} onChange={e=>setCat(e.target.value)}>
                      <option value="ì „ì²´">ì „ì²´</option>
                      {CATEGORIES.map(c=> <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>
                  <div className="mt-2 text-xs text-slate-500 dark:text-slate-400">{loading? 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦' : `ì´ ${entries.length}ê°œ ê²°ê³¼`}</div>
                </div>

                <ul className="grid md:grid-cols-2 gap-3">
                  {entries.map(e=> (
                    <li key={e.id} className="p-5 rounded-2xl border dark:border-slate-800">
                      {editingId===e.id ? (
                        <div className="space-y-3">
                          <div className="flex items-center justify-between"><h3 className="font-semibold">ìˆ˜ì •: {e.word}</h3><span className="text-xs">{new Date(e.created_at).toLocaleString()}</span></div>
                          <Field label="ë‹¨ì–´"><input className="input" value={edit.word} onChange={ev=>setEdit({...edit, word:ev.target.value})}/></Field>
                          <Field label="ëœ»"><textarea rows=3 className="input" value={edit.meaning} onChange={ev=>setEdit({...edit, meaning:ev.target.value})}/></Field>
                          <Field label="ë¶„ë¥˜"><select className="input" value={edit.category} onChange={ev=>setEdit({...edit, category:ev.target.value})}>{CATEGORIES.map(c=> <option key={c} value={c}>{c}</option>)}</select></Field>
                          <Field label="ë§Œë“ ë°©ë²•"><input className="input" value={edit.method} onChange={ev=>setEdit({...edit, method:ev.target.value})}/></Field>
                          <div className="flex gap-2">
                            <button className="btn" disabled={busy} onClick={saveEdit}>ì €ì¥</button>
                            <button className="btn-outline" onClick={cancelEdit}>ì·¨ì†Œ</button>
                          </div>
                        </div>
                      ) : (
                        <div>
                          <div className="flex items-center justify-between"><h3 className="font-semibold">{e.word}</h3><span className="text-xs">{new Date(e.created_at).toLocaleString()}</span></div>
                          <div className="mt-2 text-sm whitespace-pre-wrap">{e.meaning}</div>
                          {e.method && <div className="mt-1 text-xs text-slate-600 dark:text-slate-400">ë§Œë“ ë°©ë²•: {e.method}</div>}
                          <div className="flex gap-2 mt-3">
                            <button className="btn-outline" onClick={()=>beginEdit(e)}>ìˆ˜ì •</button>
                            <button className="btn-outline" onClick={()=>removeEntry(e.id)}>ì‚­ì œ</button>
                          </div>
                        </div>
                      )}
                    </li>
                  ))}
                </ul>
              </section>
            </main>

            <style>{`
              .input{ @apply w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-400; }
              .btn{ @apply px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold hover:opacity-90; }
              .btn-outline{ @apply px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm hover:bg-slate-50 dark:hover:bg-slate-800; }
            `}</style>
          </div>
        );
      }

      const Field = ({label, children}) => (
        <label className="grid gap-1"><span className="text-xs text-slate-600 dark:text-slate-300">{label}</span>{children}</label>
      );

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
