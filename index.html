<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¨ì–´ ì‚¬ì „ Â· íŒŒë€ í…Œë§ˆ</title>
  <script>
    // Tailwind on CDN
    tailwind = {
      config: {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "Pretendard", "ui-sans-serif", "system-ui"] },
            colors: { brand: { 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' } },
            boxShadow: { soft: '0 12px 30px -15px rgba(0,0,0,.35)' }
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ color-scheme: light dark }
    html,body{ height:100% }
    body{ font-family: Inter, Pretendard, ui-sans-serif, system-ui; }
    /* Subtle grid bg */
    .bg-grid { background-image: radial-gradient(circle at 1px 1px, rgba(37,99,235,.12) 1px, transparent 0); background-size: 22px 22px; }
    .dark .bg-grid { background-image: radial-gradient(circle at 1px 1px, rgba(96,165,250,.18) 1px, transparent 0) }
    /* UI atoms */
    .input{ @apply w-full rounded-xl border-2 border-slate-300/80 dark:border-slate-700/90 bg-white/80 dark:bg-slate-900/70 backdrop-blur px-3 py-2 text-sm outline-none focus:border-brand-600 focus:ring-2 focus:ring-brand-500/40; }
    .btn{ @apply inline-flex items-center justify-center gap-1 rounded-xl px-4 py-2 text-sm font-semibold transition active:translate-y-[1px]; }
    .btn-primary{ @apply bg-brand-600 text-white border-2 border-brand-700 hover:bg-brand-700; }
    .btn-ghost{ @apply border-2 border-slate-300/80 dark:border-slate-700/90 hover:bg-slate-50/70 dark:hover:bg-slate-800/60; }
    .tag{ @apply text-xs px-2.5 py-1 rounded-full border-2 border-slate-300/80 dark:border-slate-700/90 bg-white/70 dark:bg-slate-900/70; }
    .card{ @apply rounded-2xl border-2 border-slate-200/80 dark:border-slate-800/90 bg-white/80 dark:bg-slate-900/70 backdrop-blur shadow-soft; }
    .divider{ @apply h-[1px] bg-slate-200 dark:bg-slate-800 my-3; }
    .link{ @apply text-brand-600 hover:underline; }
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-slate-50 to-sky-50 dark:from-slate-950 dark:to-slate-900 bg-grid text-slate-900 dark:text-slate-100">
  <div class="mx-auto max-w-6xl px-4 py-6 space-y-6">
    <!-- Header -->
    <header class="card sticky top-4 z-10 px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 grid place-items-center rounded-xl bg-brand-600 text-white border-2 border-brand-700">ğŸ”¤</div>
        <div>
          <div class="text-lg font-semibold">ë‹¨ì–´ ë“±ë¡Â·ê²€ìƒ‰Â·ìˆ˜ì •/ì‚­ì œ</div>
          <div class="text-xs text-slate-500 dark:text-slate-400">Supabase RPC ë³´í˜¸ Â· ë¹„ë°€ë²ˆí˜¸ í•„ìš”</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="badge" class="tag">ğŸ”’ ì ê¸ˆ ì¤‘</span>
        <button id="btnTheme" class="btn btn-ghost" title="í…Œë§ˆ ì „í™˜">ğŸŒ—</button>
        <button id="btnOpenPwd" class="btn btn-ghost">ê´€ë¦¬ì</button>
      </div>
    </header>

    <!-- Row: Add + Search -->
    <div class="grid md:grid-cols-3 gap-6">
      <!-- Add -->
      <section class="card p-5 md:col-span-1">
        <h2 class="font-semibold">ë‹¨ì–´ ë“±ë¡</h2>
        <div class="mt-3 grid gap-3">
          <label class="grid gap-1"><span class="text-xs text-slate-600 dark:text-slate-300">ë‹¨ì–´</span>
            <input id="newWord" class="input" placeholder="ì˜ˆ: ë¹—ëª¨ì§ˆë‹¤" />
          </label>
          <label class="grid gap-1"><span class="text-xs text-slate-600 dark:text-slate-300">ëœ»</span>
            <textarea id="newMeaning" rows="3" class="input" placeholder="ì˜ˆ: íš¡í¬(æ©«æš´)í•˜ë‹¤"></textarea>
          </label>
          <label class="grid gap-1"><span class="text-xs text-slate-600 dark:text-slate-300">ë¶„ë¥˜</span>
            <select id="newCat" class="input">
              <option>ìˆëŠ”ë§</option>
              <option>ìˆë˜ë§</option>
              <option>ë§Œë“ ë§</option>
            </select>
          </label>
          <label class="grid gap-1"><span class="text-xs text-slate-600 dark:text-slate-300">ë§Œë“ ë°©ë²•</span>
            <input id="newMethod" class="input" placeholder="ì˜ˆ: pisk-(æ©«) + mwÇ’til-(æš´) ì§ì—­"/>
          </label>
          <div class="flex gap-2">
            <button id="btnAdd" class="btn btn-primary">ì¶”ê°€</button>
            <button id="btnClear" class="btn btn-ghost">ì´ˆê¸°í™”</button>
          </div>
          <p id="sysAdd" class="text-xs text-rose-500"></p>
        </div>
      </section>

      <!-- Search -->
      <section class="card p-5 md:col-span-2">
        <h2 class="font-semibold">ê²€ìƒ‰</h2>
        <div class="mt-3 grid md:grid-cols-3 gap-3">
          <input id="q" class="input md:col-span-2" placeholder="ë‹¨ì–´/ëœ»/ë§Œë“ ë°©ë²• ê²€ìƒ‰" />
          <select id="filterCat" class="input">
            <option>ì „ì²´</option>
            <option>ìˆëŠ”ë§</option>
            <option>ìˆë˜ë§</option>
            <option>ë§Œë“ ë§</option>
          </select>
        </div>
        <div class="mt-2 text-xs text-slate-500 dark:text-slate-400 flex items-center gap-2">
          <span id="count">â€“</span>
          <button id="btnReload" class="btn btn-ghost px-2 py-1">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </section>
    </div>

    <!-- List -->
    <ul id="list" class="grid md:grid-cols-2 gap-4"></ul>

    <!-- Toasts -->
    <div id="toasts" class="fixed top-4 right-4 space-y-2 z-50"></div>
  </div>

  <!-- Password Modal -->
  <div id="pwdModal" class="hidden fixed inset-0 z-40 bg-black/40 backdrop-blur-sm grid place-items-center p-4">
    <div class="card w-full max-w-sm p-5">
      <h3 class="font-semibold">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
      <input id="pwd" type="password" class="input mt-3" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <div class="flex gap-2 mt-4">
        <button id="btnVerify" class="btn btn-primary">í™•ì¸</button>
        <button id="btnClosePwd" class="btn btn-ghost">ë‹«ê¸°</button>
      </div>
      <p id="sysPwd" class="text-xs text-rose-500 mt-2"></p>
    </div>
  </div>

  <script>
  (function(){
    // â–¼ ì‚¬ìš©ì í”„ë¡œì íŠ¸ ì—°ê²°ê°’
    const SUPABASE_URL = "https://fbyilsyeygaucdbaexut.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZieWlsc3lleWdhdWNkYmFleHV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTkyNDEsImV4cCI6MjA3MTY3NTI0MX0.2c-_df6s-3cxa1YkxsqD04Hql_5OXKeTPhidz7jNvQQ";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { adminOK:false, adminPwd:'', q:'', cat:'ì „ì²´', entries:[], loading:false };
    const $ = (s) => document.querySelector(s);

    // Theme
    const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.classList.toggle('dark', prefers);
    $('#btnTheme').addEventListener('click', () => document.documentElement.classList.toggle('dark'));

    // Toast helper
    function toast(msg, type='ok'){
      const t = document.createElement('div');
      t.className = `rounded-xl px-3 py-2 text-sm shadow-soft border-2 ${type==='ok' ? 'bg-brand-600 text-white border-brand-700' : 'bg-rose-600 text-white border-rose-700'}`;
      t.textContent = msg; $('#toasts').appendChild(t); setTimeout(()=>{ t.remove(); }, 1800);
    }

    function setBadge(){ $('#badge').textContent = state.adminOK ? 'ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ' : 'ğŸ”’ ì ê¸ˆ ì¤‘'; }

    // Modal open/close
    const openPwd = () => $('#pwdModal').classList.remove('hidden');
    const closePwd = () => $('#pwdModal').classList.add('hidden');
    $('#btnOpenPwd').addEventListener('click', openPwd);
    $('#btnClosePwd').addEventListener('click', closePwd);

    async function verifyPwd(){
      $('#sysPwd').textContent = '';
      const value = $('#pwd').value; if(!value){ $('#sysPwd').textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
      const { data, error } = await db.rpc('can_edit', { pwd: value });
      if(error){ $('#sysPwd').textContent = error.message; state.adminOK=false; setBadge(); return; }
      if(!data){ $('#sysPwd').textContent = 'í‹€ë ¸ìŠµë‹ˆë‹¤.'; state.adminOK=false; setBadge(); return; }
      state.adminOK = true; state.adminPwd = value; setBadge(); closePwd(); toast('ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”');
    }
    $('#btnVerify').addEventListener('click', verifyPwd);

    async function load(){
      state.q = $('#q').value.trim(); state.cat = $('#filterCat').value; $('#count').textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      let query = db.from('entries').select('*').order('created_at', { ascending:false });
      if(state.cat !== 'ì „ì²´') query = query.eq('category', state.cat);
      if(state.q) query = query.or(`word.ilike.%${state.q}%,meaning.ilike.%${state.q}%,method.ilike.%${state.q}%`);
      const { data, error } = await query;
      if(error){ $('#count').textContent='ì˜¤ë¥˜'; toast(error.message, 'err'); return; }
      state.entries = data || []; $('#count').textContent = `ì´ ${state.entries.length}ê°œ ê²°ê³¼`;
      renderList();
    }

    function renderList(){
      const root = $('#list'); root.innerHTML = '';
      for(const e of state.entries){
        const li = document.createElement('li'); li.className = 'card p-5';
        li.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <div class="text-base font-semibold">${esc(e.word)}</div>
              <div class="text-xs text-slate-500 dark:text-slate-400">${new Date(e.created_at).toLocaleString()}</div>
            </div>
            <span class="tag">${esc(e.category)}</span>
          </div>
          <div class="mt-3 text-sm whitespace-pre-wrap">${esc(e.meaning)}</div>
          ${e.method ? `<div class="mt-2 text-xs text-slate-500">ë§Œë“ ë°©ë²•: ${esc(e.method)}</div>` : ''}

          <div class="divider"></div>

          <div class="mt-1 flex gap-2 justify-end">
            <button class="btn btn-ghost" data-edit="${e.id}">ìˆ˜ì •</button>
            <button class="btn btn-ghost" data-del="${e.id}">ì‚­ì œ</button>
          </div>

          <div id="edit-${e.id}" class="hidden mt-4 grid gap-2">
            <div class="grid md:grid-cols-2 gap-2">
              <input id="ew-${e.id}" class="input" value="${escAttr(e.word)}" />
              <select id="ec-${e.id}" class="input">
                ${['ìˆëŠ”ë§','ìˆë˜ë§','ë§Œë“ ë§'].map(c=>`<option ${c===e.category?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <textarea id="em-${e.id}" rows="3" class="input">${esc(e.meaning)}</textarea>
            <input id="ed-${e.id}" class="input" value="${escAttr(e.method||'')}" placeholder="ë§Œë“ ë°©ë²•" />
            <div class="flex gap-2 justify-end">
              <button class="btn btn-primary" data-save="${e.id}">ì €ì¥</button>
              <button class="btn btn-ghost" data-cancel="${e.id}">ì·¨ì†Œ</button>
            </div>
          </div>
        `;
        root.appendChild(li);
      }
    }

    function listClick(ev){
      const t = ev.target; const id = t.getAttribute('data-edit') || t.getAttribute('data-del') || t.getAttribute('data-save') || t.getAttribute('data-cancel');
      if(!id) return; if(t.hasAttribute('data-edit')) return openEdit(id); if(t.hasAttribute('data-cancel')) return closeEdit(id);
      if(t.hasAttribute('data-save')) return saveEdit(id); if(t.hasAttribute('data-del')) return removeEntry(id);
    }
    document.addEventListener('click', (ev)=>{
      if(ev.target.closest('#list')) listClick(ev);
    });

    function openEdit(id){ if(!state.adminOK){ toast('ë¨¼ì € ê´€ë¦¬ì ì¸ì¦ì„ í•´ì£¼ì„¸ìš”','err'); return; } $('#edit-'+id).classList.remove('hidden'); }
    function closeEdit(id){ $('#edit-'+id).classList.add('hidden'); }

    async function saveEdit(id){
      if(!state.adminOK){ toast('ë¨¼ì € ê´€ë¦¬ì ì¸ì¦ì„ í•´ì£¼ì„¸ìš”','err'); return; }
      const word = $('#ew-'+id).value.trim(); const meaning = $('#em-'+id).value.trim(); const category = $('#ec-'+id).value; const method = $('#ed-'+id).value.trim();
      if(!word || !meaning){ toast('ë‹¨ì–´/ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤','err'); return; }
      const { error } = await db.rpc('entry_update_admin', { p_id:id, p_word:word, p_meaning:meaning, p_category:category, p_method:method, p_pwd: state.adminPwd });
      if(error){ toast('ìˆ˜ì • ì˜¤ë¥˜: '+error.message,'err'); return; }
      toast('ìˆ˜ì • ì™„ë£Œ'); closeEdit(id); load();
    }

    async function removeEntry(id){
      if(!state.adminOK){ toast('ë¨¼ì € ê´€ë¦¬ì ì¸ì¦ì„ í•´ì£¼ì„¸ìš”','err'); return; }
      if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
      const { error } = await db.rpc('entry_delete_admin', { p_id:id, p_pwd: state.adminPwd });
      if(error){ toast('ì‚­ì œ ì˜¤ë¥˜: '+error.message,'err'); return; }
      toast('ì‚­ì œ ì™„ë£Œ'); load();
    }

    async function addEntry(){
      const word = $('#newWord').value.trim(); const meaning = $('#newMeaning').value.trim(); const category = $('#newCat').value; const method = $('#newMethod').value.trim();
      if(!word || !meaning){ $('#sysAdd').textContent='ë‹¨ì–´/ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'; return; }
      const { error } = await db.from('entries').insert([{ word, meaning, category, method }]);
      if(error){ $('#sysAdd').textContent='ì¶”ê°€ ì˜¤ë¥˜: '+error.message; return; }
      $('#sysAdd').textContent=''; $('#newWord').value=''; $('#newMeaning').value=''; $('#newMethod').value=''; toast('ì¶”ê°€ ì™„ë£Œ'); load();
    }

    $('#btnAdd').addEventListener('click', addEntry);
    $('#btnClear').addEventListener('click', ()=>{ $('#newWord').value=''; $('#newMeaning').value=''; $('#newMethod').value=''; });
    $('#btnReload').addEventListener('click', load);
    $('#q').addEventListener('input', ()=>{ clearTimeout(window._q); window._q = setTimeout(load, 250); });
    $('#filterCat').addEventListener('change', load);

    function esc(s=''){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
    function escAttr(s=''){ return esc(s).replace(/\n/g,' '); }

    setBadge(); load();
  })();
  </script>
</body>
</html>
